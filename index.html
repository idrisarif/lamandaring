<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Pengguna - Lamandaring</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h2>Halo, selamat datang <span id="user-nama">Memuat...</span>!</h2> 
        <p>Ini adalah halaman khusus untuk Anda sebagai pengguna biasa.</p>
        <button id="logout-btn" class="button-logout">Logout</button>
        <p id="admin-link-container" style="display:none; margin-top: 20px;">
            <a href="admin.html">Akses Halaman Admin</a>
        </p>
    </div>

    <script type="module" src="./auth.js"></script>
    
    <script type="module">
        // Impor fungsi yang diperlukan
        import { checkAuthAndRedirect, handleLogout, fetchAndStoreUserName } from './auth.js';
        
        document.addEventListener('DOMContentLoaded', async () => {
            const userNamaElement = document.getElementById('user-nama');
            const adminLinkContainer = document.getElementById('admin-link-container');
            const logoutBtn = document.getElementById('logout-btn'); // ID yang benar

            // 1. Cek Sesi: Redirect jika belum login
            const user = await checkAuthAndRedirect();
            
            if (user) {
                let namaPengguna = 'Pengguna';
                let rolePengguna = 'user';

                // Coba ambil data dari localStorage terlebih dahulu (lebih cepat)
                const storedName = localStorage.getItem('nama');
                const storedRole = localStorage.getItem('role');

                if (storedName && storedRole) {
                    namaPengguna = storedName;
                    rolePengguna = storedRole;
                } else {
                    // Jika tidak ada di localStorage, ambil dari database dan simpan
                    const userData = await fetchAndStoreUserName(user.id);
                    if (userData) {
                        namaPengguna = userData.nama;
                        rolePengguna = userData.role;
                    } else {
                        // Gagal fetch, tampilkan pesan default
                        console.error("Gagal memuat data nama/role dari database.");
                    }
                }
                
                // Tampilkan data yang sudah didapat (baik dari LocalStorage atau DB)
                userNamaElement.textContent = namaPengguna;

                // Tampilkan link admin jika role adalah admin
                if (rolePengguna === 'admin') {
                     adminLinkContainer.style.display = 'block';
                }
            }

            // 3. Tambahkan event listener untuk tombol logout (menggunakan ID yang benar)
            if (logoutBtn) {
                 logoutBtn.addEventListener('click', handleLogout);
            }
        });
    </script>
</body>
</html>