<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data User</title>
    <link rel="icon" type="image/x-icon" href="images/pic-1.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js';

        const supabaseUrl = 'https://iwioqeqmljulcyiiuese.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3aW9xZXFtbGp1bGN5aWl1ZXNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMTkxMTUsImV4cCI6MjA3NDY5NTExNX0.6MRxNgTtEldhHVKVMhM7kffH4qF-iPGYk2_xmULGBG8';
        const supabase = createClient(supabaseUrl, supabaseKey);

        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                console.log('Login OK:', session.user.email);
                document.getElementById('userName').innerText = localStorage.getItem('nama') || 'Pengguna';
                loadAllUsers();
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadAllUsers() {
            const { data, error } = await supabase
                .from('user')
                .select('*');
            
            if (error) {
                console.error('Error load data:', error);
                return;
            }
        
            const tableBody = document.getElementById('userTableBody');
            tableBody.innerHTML = '';
        
            data.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Nama:">${user.nama}</td> 
                    <td data-label="Email:">${user.email}</td>
                    <td data-label="Role:">${user.role}</td>
                    <td data-label="Aksi:">
                        <button onclick="editUser('${user.user_id}')">Edit</button>
                        <button onclick="deleteUser('${user.user_id}')">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        let editingUserId = null;

        window.deleteUser = async function(id) {
            const { error } = await supabase
                .from('user')
                .delete()
                .eq('user_id', id);

            if (error) {
                alert('Gagal menghapus user: ' + error.message);
                return;
            }

            alert('User berhasil dihapus!');
            await loadAllUsers();
        };

        window.editUser = async function(id) {
            const { data, error } = await supabase
                .from('user')
                .select('*')
                .eq('user_id', id)
                .single();

            if (error) {
                alert('Gagal mengambil data user: ' + error.message);
                return;
            }

            document.querySelector('#userForm [name="nama"]').value = data.nama;
            document.querySelector('#userForm [name="email"]').value = data.email;
            document.querySelector('#userForm [name="role"]').value = data.role;

            document.getElementById("userModalTitle").innerText = "Edit User";
            editingUserId = id;
            modal.style.display = "block";
        };

        const userForm = document.getElementById('userForm');
        
        userForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(userForm);
            const userData = Object.fromEntries(formData.entries());

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                alert('Silakan login kembali.');
                window.location.href = 'login.html';
                return;
            }

            let error;
            if (editingUserId) {
                const res = await supabase
                    .from('user')
                    .update(userData)
                    .eq('user_id', editingUserId);
                error = res.error;
                editingUserId = null;
            } else {
                const res = await supabase
                    .from('user')
                    .insert([userData]);
                error = res.error;
            }

            if (error) {
                alert('Gagal menyimpan user: ' + error.message);
                return;
            }

            alert('User berhasil disimpan!');
            modal.style.display = "none";
            await loadAllUsers();
            userForm.reset();
        });

        const modal = document.getElementById("userModal");
        const btn = document.getElementById("openModalBtn");
        const span = document.querySelector(".close");
        
        btn.onclick = function() {
            document.getElementById("userModalTitle").innerText = "Tambah User";
            editingUserId = null;
            userForm.reset();
            modal.style.display = "block";
        };
        
        span.onclick = function() {
            modal.style.display = "none";
            editingUserId = null;
        };

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = "none";
                editingUserId = null;
            }
        };

        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn.addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error logging out:', error.message);
            } else {
                localStorage.removeItem('nama');
                window.location.href = 'login.html';
            }
        });

    </script>
</head>
<body>

    <header class="header">
        <section class="flex">
            <a href="admin-user.html" class="logo">lamandaring</a>
            <div class="icons">
                <div id="user-btn" class="fas fa-user"></div>
                <div id="toggle-btn" class="fas fa-sun"></div>
            </div>
            <div class="profile">
                <p class="role">Halo</p>
                <h3 class="name" id="userName"></h3>
                <p><span id="role"></span></p>
                <a id="logoutBtn" class="delete-btn">Keluar</a>
            </div>
        </section>
    </header>

    <div class="admin-welcome-content">
        <h2>Halo, selamat datang <span id="homeUserName">Memuat...</span>!</h2>
        <p>Ini adalah halaman khusus untuk Anda sebagai admmin.</p>
     </div>

    <div>
        <button id="openModalBtn">Tambah +</button>
        <div id="userModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 id="userModalTitle">Tambah User</h3>
                <form id="userForm">
                    <input type="text" name="nama" placeholder="Nama Lengkap" required>
                    <input type="email" name="email" placeholder="Email" required>
                    <select name="role" required>
                        <option value="">Pilih Role</option>
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                    </select>
                    <button type="submit">Simpan</button>
                </form>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
            </tbody>
        </table>
    </div>

<script src="js/script.js" type="module"></script>
    
</body>
</html>